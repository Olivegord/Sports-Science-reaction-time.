<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Session Data</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(135deg, rgba(30, 136, 229, 0.16), rgba(106, 27, 154, 0.2));
      display: flex;
      align-items: center;
      justify-content: center;
      padding: clamp(1.5rem, 5vw, 3rem);
      color: #0f172a;
    }

    main {
      width: min(960px, 100%);
      background: rgba(255, 255, 255, 0.95);
      border-radius: 28px;
      box-shadow: 0 32px 70px rgba(15, 23, 42, 0.12);
      padding: clamp(1.75rem, 4vw, 3rem);
      display: grid;
      gap: 2rem;
    }

    h1 {
      margin: 0;
      font-size: clamp(2.2rem, 6vw, 3.3rem);
      text-align: center;
    }

    .meta {
      text-align: center;
      font-size: 1.05rem;
      opacity: 0.7;
    }

    section.set {
      background: rgba(15, 23, 42, 0.05);
      border-radius: 22px;
      padding: clamp(1rem, 3vw, 1.75rem);
    }

    section.set h2 {
      margin: 0 0 0.75rem;
      font-size: clamp(1.4rem, 4vw, 1.9rem);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 0.6rem 0.7rem;
      border-bottom: 1px solid rgba(15, 23, 42, 0.1);
      text-align: left;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    caption {
      caption-side: bottom;
      padding-top: 0.6rem;
      font-size: 0.95rem;
      opacity: 0.7;
    }

    .empty {
      text-align: center;
      font-size: 1.1rem;
      padding: 2rem;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.9);
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.08);
    }

    a {
      color: #1e88e5;
      font-weight: 600;
      text-decoration: none;
      text-align: center;
    }
  </style>
</head>
<body>
  <main>
    <h1>Session Data</h1>
    <div id="meta" class="meta"></div>
    <div id="tables"></div>
    <div id="empty" class="empty" hidden>No saved session found yet. Run the experiment to collect data.</div>
    <a href="index.html">Back to tester</a>
  </main>
  <script>
    const loadSession = () => {
      try {
        const raw = window.localStorage.getItem('reactionTimeSession');
        if (!raw) return null;
        return JSON.parse(raw);
      } catch (error) {
        console.error('Failed to parse stored session', error);
        return null;
      }
    };

    const normaliseSession = (data) => {
      if (!data) return null;
      if (Array.isArray(data.sets)) return data;
      if (Array.isArray(data.trials)) {
        return {
          recordedAt: data.recordedAt || new Date().toISOString(),
          trialsPerSet: data.trials.length,
          totalSets: 1,
          overallAverage: data.average,
          sets: [
            {
              key: 'baseline',
              label: 'Baseline (legacy import)',
              trials: data.trials,
              average: data.average,
            },
          ],
        };
      }
      return null;
    };

    const session = normaliseSession(loadSession());
    const tables = document.getElementById('tables');
    const meta = document.getElementById('meta');
    const empty = document.getElementById('empty');

    if (!session) {
      empty.hidden = false;
    } else {
      const recorded = new Date(session.recordedAt);
      meta.textContent = `Recorded ${recorded.toLocaleString()} • ${session.totalSets || session.sets.length} sets × ${session.trialsPerSet || (session.sets[0]?.trials?.length ?? 0)} trials`;
      session.sets.forEach((set, index) => {
        const section = document.createElement('section');
        section.className = 'set';
        const heading = document.createElement('h2');
        heading.textContent = `Set ${index + 1}: ${set.label}`;
        section.appendChild(heading);
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const headRow = document.createElement('tr');
        ['Trial', 'Reaction time (ms)'].forEach((label) => {
          const th = document.createElement('th');
          th.textContent = label;
          headRow.appendChild(th);
        });
        thead.appendChild(headRow);
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        (set.trials || []).forEach((trial, trialIndex) => {
          const row = document.createElement('tr');
          const cellIndex = document.createElement('td');
          cellIndex.textContent = trialIndex + 1;
          const cellValue = document.createElement('td');
          const value = Number(trial);
          cellValue.textContent = Number.isFinite(value) ? `${value.toFixed(1)}` : '—';
          row.appendChild(cellIndex);
          row.appendChild(cellValue);
          tbody.appendChild(row);
        });
        table.appendChild(tbody);
        const caption = document.createElement('caption');
        if (typeof set.average === 'number') {
          caption.textContent = `${set.trials.length} trials • Average ${set.average.toFixed(1)} ms`;
        } else {
          caption.textContent = `${set.trials.length} trials`;
        }
        table.appendChild(caption);
        section.appendChild(table);
        tables.appendChild(section);
      });

      if (typeof session.overallAverage === 'number') {
        const overall = document.createElement('section');
        overall.className = 'set';
        const heading = document.createElement('h2');
        heading.textContent = 'Overall average';
        const para = document.createElement('p');
        const totalTrials = Number.isFinite(session.trialsPerSet) && Number.isFinite(session.totalSets)
          ? session.trialsPerSet * session.totalSets
          : session.sets.reduce((sum, set) => sum + (set.trials?.length ?? 0), 0);
        para.textContent = `${session.overallAverage.toFixed(1)} ms across ${totalTrials} trials`;
        overall.appendChild(heading);
        overall.appendChild(para);
        tables.appendChild(overall);
      }
    }

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').catch((error) => {
          console.error('Service worker registration failed', error);
        });
      });
    }
  </script>
</body>
</html>
